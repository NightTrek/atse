╔════════════════════════════════════════════════════════════╗
║   ATSE COMPREHENSIVE REGRESSION TEST SUITE                 ║
║   Date: Tue Nov 18 22:14:44 PST 2025                            ║
║   Test Codebase: dgraph (544 Go files, 6428 symbols)      ║
╚════════════════════════════════════════════════════════════╝

Starting comprehensive test suite...

═══════════════════════════════════════════════════════════
CATEGORY 1: SEARCH COMMAND TESTS (8 tests)
═══════════════════════════════════════════════════════════

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 1: Basic search with limit
Command: ./atse search 'Query' /Users/danielsteigman/code/randomSource/dgraph --limit 5 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.776s
Files Processed:  346
Results Found:    5
Output Tokens:    89 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 2: Search with fuzzy matching
Command: ./atse search 'Auth' /Users/danielsteigman/code/randomSource/dgraph --fuzzy --limit 10 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.749s
Files Processed:  346
Results Found:    10
Output Tokens:    168 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 3: Search with type filter (function)
Command: ./atse search 'Process' /Users/danielsteigman/code/randomSource/dgraph --type function --limit 5 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.751s
Files Processed:  346
Results Found:    5
Output Tokens:    83 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 4: Search with type filter (method)
Command: ./atse search 'Handle' /Users/danielsteigman/code/randomSource/dgraph --type method --limit 5 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.753s
Files Processed:  346
Results Found:    5
Output Tokens:    74 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 5: Search non-existent symbol (edge case)
Command: ./atse search 'NonExistentXYZ123' /Users/danielsteigman/code/randomSource/dgraph --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.752s
Files Processed:  346
Results Found:    0
Output Tokens:    6 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 6: Search with filtering disabled
Command: ./atse search 'Test' /Users/danielsteigman/code/randomSource/dgraph --exclude-defaults=false --limit 10 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         1.162s
Files Processed:  547
Results Found:    10
Output Tokens:    192 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 7: Search with production-only flag
Command: ./atse search 'Server' /Users/danielsteigman/code/randomSource/dgraph --production-only --limit 5 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.755s
Files Processed:  346
Results Found:    5
Output Tokens:    82 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 8: Search with JSON output format
Command: ./atse search 'Login' /Users/danielsteigman/code/randomSource/dgraph --format json --limit 3 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.775s
Files Processed:  346
Results Found:    3
Output Tokens:    190 (o200k_base)
✅ STATUS: PASS (exit code: 0)

═══════════════════════════════════════════════════════════
CATEGORY 2: FIND-FN COMMAND TESTS (10 tests)
═══════════════════════════════════════════════════════════

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 9: find-fn with default limit (50)
Command: ./atse find-fn 'New' /Users/danielsteigman/code/randomSource/dgraph --benchmark 2>&1 | grep -E '(Warning|Duration|Files|Results|Tokens)'

Duration:         0.717s
Files Processed:  346
Results Found:    50
Output Tokens:    1250 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 10: find-fn with custom limit (20)
Command: ./atse find-fn 'Error' /Users/danielsteigman/code/randomSource/dgraph --limit 20 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.623s
Files Processed:  346
Results Found:    20
Output Tokens:    500 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 11: find-fn with unlimited results
Command: ./atse find-fn 'len' /Users/danielsteigman/code/randomSource/dgraph --limit 0 --benchmark 2>&1 | head -15 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.638s
Files Processed:  346
Results Found:    50
Output Tokens:    1250 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 12: find-fn with high limit (stress test)
Command: ./atse find-fn 'Get' /Users/danielsteigman/code/randomSource/dgraph --limit 200 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.627s
Files Processed:  346
Results Found:    200
Output Tokens:    5054 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 13: find-fn non-existent function (edge case)
Command: ./atse find-fn 'NonExistentFunc999' /Users/danielsteigman/code/randomSource/dgraph --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.622s
Files Processed:  346
Results Found:    50
Output Tokens:    1250 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 14: find-fn with filtering disabled
Command: ./atse find-fn 'Setup' /Users/danielsteigman/code/randomSource/dgraph --exclude-defaults=false --limit 10 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.945s
Files Processed:  547
Results Found:    10
Output Tokens:    250 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 15: find-fn with production-only
Command: ./atse find-fn 'Query' /Users/danielsteigman/code/randomSource/dgraph --production-only --limit 15 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.644s
Files Processed:  346
Results Found:    15
Output Tokens:    375 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 16: find-fn with include pattern
Command: ./atse find-fn 'Parse' /Users/danielsteigman/code/randomSource/dgraph --include '*.go' --limit 10 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.639s
Files Processed:  343
Results Found:    10
Output Tokens:    250 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 17: find-fn with exclude pattern
Command: ./atse find-fn 'Handle' /Users/danielsteigman/code/randomSource/dgraph --exclude '*_test.go' --limit 10 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.625s
Files Processed:  346
Results Found:    10
Output Tokens:    250 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 18: find-fn with verbose mode
Command: ./atse find-fn 'Run' /Users/danielsteigman/code/randomSource/dgraph --verbose --limit 5 --benchmark 2>&1 | grep -E '(Warning|Duration|Files|Results|Tokens)'

Warning: Found 10872 results, showing first 5 (use --limit 0 for all, or --limit N to adjust)
Duration:         0.630s
Files Processed:  346
Results Found:    5
Output Tokens:    140 (o200k_base)
✅ STATUS: PASS (exit code: 0)

═══════════════════════════════════════════════════════════
CATEGORY 3: GRAPH COMMAND TESTS (8 tests)
═══════════════════════════════════════════════════════════

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 19: graph BFS depth 1
Command: ./atse graph 'Query' /Users/danielsteigman/code/randomSource/dgraph --mode bfs --depth 1 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         1.634s
Files Processed:  346
Results Found:    1
Output Tokens:    45 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 20: graph BFS depth 2
Command: ./atse graph 'Server' /Users/danielsteigman/code/randomSource/dgraph --mode bfs --depth 2 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

❌ STATUS: FAIL (expected 0, got 1)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 21: graph DFS depth 2
Command: ./atse graph 'Login' /Users/danielsteigman/code/randomSource/dgraph --mode dfs --depth 2 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         1.661s
Files Processed:  346
Results Found:    7
Output Tokens:    161 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 22: graph DFS depth 3 (deep)
Command: ./atse graph 'Process' /Users/danielsteigman/code/randomSource/dgraph --mode dfs --depth 3 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         1.650s
Files Processed:  346
Results Found:    4
Output Tokens:    97 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 23: graph with max-symbols limit
Command: ./atse graph 'Handle' /Users/danielsteigman/code/randomSource/dgraph --depth 2 --max-symbols 50 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

❌ STATUS: FAIL (expected 0, got 1)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 24: graph non-existent symbol (edge case)
Command: ./atse graph 'NonExistentSymbol999' /Users/danielsteigman/code/randomSource/dgraph --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens|not found)'

Symbol 'NonExistentSymbol999' not found in codebase.
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 25: graph with verbose mode
Command: ./atse graph 'Auth' /Users/danielsteigman/code/randomSource/dgraph --depth 1 --verbose --benchmark 2>&1 | grep -E '(Index complete|Duration|Files|Results|Tokens)'

  ✓ Index complete: 346 files, 3950 symbols, 1137 types, 346 imports
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 26: graph with rebuild-index flag
Command: ./atse graph 'User' /Users/danielsteigman/code/randomSource/dgraph --depth 1 --rebuild-index --benchmark 2>&1 | grep -E '(rebuild|Duration|Files|Results|Tokens)'

❌ STATUS: FAIL (expected 0, got 1)

═══════════════════════════════════════════════════════════
CATEGORY 4: EXTRACT COMMAND TESTS (6 tests)
═══════════════════════════════════════════════════════════

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 27: extract BFS depth 1
Command: ./atse extract 'Query' /Users/danielsteigman/code/randomSource/dgraph --mode bfs --depth 1 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         1.636s
Files Processed:  346
Results Found:    1
Output Tokens:    104 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 28: extract DFS depth 1
Command: ./atse extract 'Server' /Users/danielsteigman/code/randomSource/dgraph --mode dfs --depth 1 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

❌ STATUS: FAIL (expected 0, got 1)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 29: extract depth 2 (moderate)
Command: ./atse extract 'Login' /Users/danielsteigman/code/randomSource/dgraph --depth 2 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         1.731s
Files Processed:  346
Results Found:    7
Output Tokens:    1501 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 30: extract non-existent symbol (edge case)
Command: ./atse extract 'NonExistentFunc' /Users/danielsteigman/code/randomSource/dgraph --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens|not found)'

Symbol 'NonExistentFunc' not found in codebase.
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 31: extract with verbose mode
Command: ./atse extract 'Auth' /Users/danielsteigman/code/randomSource/dgraph --depth 1 --verbose --benchmark 2>&1 | grep -E '(Index|Duration|Files|Results|Tokens)'

  Indexed: 50/346 files
  Indexed: 100/346 files
  Indexed: 150/346 files
  Indexed: 200/346 files
  Indexed: 250/346 files
  Indexed: 300/346 files
  ✓ Index complete: 346 files, 3950 symbols, 1137 types, 346 imports
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 32: extract with filtering
Command: ./atse extract 'Process' /Users/danielsteigman/code/randomSource/dgraph --depth 1 --production-only --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         1.684s
Files Processed:  346
Results Found:    4
Output Tokens:    804 (o200k_base)
✅ STATUS: PASS (exit code: 0)

═══════════════════════════════════════════════════════════
CATEGORY 5: DEPS COMMAND TESTS (5 tests)
═══════════════════════════════════════════════════════════

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 33: deps single file
Command: ./atse deps /Users/danielsteigman/code/randomSource/dgraph/dgraph/edgraph/server.go --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

❌ STATUS: FAIL (expected 0, got 1)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 34: deps directory
Command: ./atse deps /Users/danielsteigman/code/randomSource/dgraph/acl --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.004s
Files Processed:  3
Results Found:    3
Output Tokens:    73 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 35: deps with verbose mode
Command: ./atse deps /Users/danielsteigman/code/randomSource/dgraph/dgraph/query/query.go --verbose --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

❌ STATUS: FAIL (expected 0, got 1)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 36: deps with JSON format
Command: ./atse deps /Users/danielsteigman/code/randomSource/dgraph/acl/acl.go --format json --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.003s
Files Processed:  1
Results Found:    1
Output Tokens:    203 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 37: deps non-existent file (edge case)
Command: ./atse deps /Users/danielsteigman/code/randomSource/dgraph/nonexistent.go --benchmark 2>&1

Error: failed to collect files: stat /Users/danielsteigman/code/randomSource/dgraph/nonexistent.go: no such file or directory
Usage:
  atse deps [path] [flags]

Flags:
  -h, --help   help for deps

Global Flags:
      --benchmark                 Display performance benchmark summary to stderr
      --exclude strings           Exclude file patterns (e.g., '*.test.ts')
      --exclude-defaults          Apply default exclude patterns for common noise (tests, generated, node_modules) (default true)
      --format string             Output format: text, json, locations (default "text")
      --include strings           Include file patterns (e.g., '*.ts')
      --include-generated         Include generated files in results
      --include-tests             Include test files in results
      --limit int                 Limit number of results (0 = no limit)
      --log-metrics               Log command output token metrics to a JSONL file
      --metrics-log-file string   Path to append metrics logs (JSONL) (default "benchmark/results/raw/token_metrics.jsonl")
      --no-cache                  Bypass parse tree cache
      --production-only           Only show production code (exclude tests, generated files)
      --rebuild-index             Force rebuild of symbol index (ignore cache)
  -r, --recursive                 Recursively search directories (default true)
      --token-model string        Model name used for token counting (for reference only) (default "gpt-4o")
  -v, --verbose                   Verbose output with additional context

failed to collect files: stat /Users/danielsteigman/code/randomSource/dgraph/nonexistent.go: no such file or directory
❌ STATUS: FAIL (expected 0, got 1)

═══════════════════════════════════════════════════════════
CATEGORY 6: LIST-FNS COMMAND TESTS (5 tests)
═══════════════════════════════════════════════════════════

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 38: list-fns single file
Command: ./atse list-fns /Users/danielsteigman/code/randomSource/dgraph/dgraph/edgraph/server.go --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

❌ STATUS: FAIL (expected 0, got 1)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 39: list-fns small directory
Command: ./atse list-fns /Users/danielsteigman/code/randomSource/dgraph/acl --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.005s
Files Processed:  3
Results Found:    26
Output Tokens:    688 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 40: list-fns with limit
Command: ./atse list-fns /Users/danielsteigman/code/randomSource/dgraph/dgraph --limit 20 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.008s
Files Processed:  3
Results Found:    20
Output Tokens:    593 (o200k_base)
/Users/danielsteigman/code/randomSource/dgraph/dgraph/cmd/alpha/http.go:123:0 - parseDuration
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 41: list-fns with filtering
Command: ./atse list-fns /Users/danielsteigman/code/randomSource/dgraph/dgraph --production-only --limit 15 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.008s
Files Processed:  3
Results Found:    15
Output Tokens:    447 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 42: list-fns with JSON format
Command: ./atse list-fns /Users/danielsteigman/code/randomSource/dgraph/acl/acl.go --format json --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.004s
Files Processed:  1
Results Found:    17
Output Tokens:    7492 (o200k_base)
✅ STATUS: PASS (exit code: 0)

═══════════════════════════════════════════════════════════
CATEGORY 7: QUERY COMMAND (TREE-SITTER) TESTS (5 tests)
═══════════════════════════════════════════════════════════

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 43: query for function declarations
Command: ./atse query '(function_declaration)' /Users/danielsteigman/code/randomSource/dgraph --limit 10 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.567s
Files Processed:  346
Results Found:    0
Output Tokens:    4 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 44: query for method declarations
Command: ./atse query '(method_declaration)' /Users/danielsteigman/code/randomSource/dgraph --limit 10 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.575s
Files Processed:  343
Results Found:    0
Output Tokens:    4 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 45: query for call expressions
Command: ./atse query '(call_expression)' /Users/danielsteigman/code/randomSource/dgraph --limit 15 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.661s
Files Processed:  346
Results Found:    0
Output Tokens:    4 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 46: query with filtering
Command: ./atse query '(function_declaration)' /Users/danielsteigman/code/randomSource/dgraph --production-only --limit 5 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.570s
Files Processed:  346
Results Found:    0
Output Tokens:    4 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 47: query invalid syntax (edge case)
Command: ./atse query 'invalid syntax here' /Users/danielsteigman/code/randomSource/dgraph --benchmark 2>&1

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚡ Performance Benchmark
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Command:          query
Duration:         0.397s
Memory (Start):   0.3 MB
Memory (Peak):    5.1 MB
Memory (End):     5.1 MB
Files Processed:  0
Results Found:    0
Output Tokens:    4 (o200k_base)
Output Chars:     17
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
No results found.✅ STATUS: PASS (exit code: 0)

═══════════════════════════════════════════════════════════
CATEGORY 8: CONTEXT COMMAND TESTS (3 tests)
═══════════════════════════════════════════════════════════

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 48: context at specific position
Command: ./atse context /Users/danielsteigman/code/randomSource/dgraph/acl/acl.go:100:5 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.002s
Files Processed:  1
Results Found:    1
Output Tokens:    340 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 49: context with verbose mode
Command: ./atse context /Users/danielsteigman/code/randomSource/dgraph/dgraph/edgraph/server.go:500:10 --verbose --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

❌ STATUS: FAIL (expected 0, got 1)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 50: context invalid position (edge case)
Command: ./atse context /Users/danielsteigman/code/randomSource/dgraph/acl/acl.go:99999:99999 --benchmark 2>&1

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚡ Performance Benchmark
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Command:          context
Duration:         0.002s
Memory (Start):   0.3 MB
Memory (Peak):    0.3 MB
Memory (End):     0.3 MB
Files Processed:  1
Results Found:    1
Output Tokens:    4972 (o200k_base)
Output Chars:     16998
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
/Users/danielsteigman/code/randomSource/dgraph/acl/acl.go:99999:99999
/*
 * SPDX-FileCopyrightText: © Hypermode Inc. <hello@hypermode.com>
 * SPDX-License-Identifier: Apache-2.0
 */

package acl

import (
	"context"
	"encoding/json"
	"errors"
	"fmt"
	"strings"
	"time"

	"github.com/golang/glog"
	"github.com/spf13/viper"

	"github.com/dgraph-io/dgo/v250"
	"github.com/dgraph-io/dgo/v250/protos/api"
	"github.com/hypermodeinc/dgraph/v25/x"
)

func getUserAndGroup(conf *viper.Viper) (userId string, groupId string, err error) {
	userId = conf.GetString("user")
	groupId = conf.GetString("group")
	if (len(userId) == 0 && len(groupId) == 0) ||
		(len(userId) != 0 && len(groupId) != 0) {
		return "", "", errors.New("one of the --user or --group must be specified, but not both")
	}
	return userId, groupId, nil
}

func checkForbiddenOpts(conf *viper.Viper, forbiddenOpts []string) error {
	for _, opt := range forbiddenOpts {
		var isSet bool
		switch conf.Get(opt).(type) {
		case string:
			if opt == "group_list" {
				// handle group_list specially since the default value is not an empty string
				isSet = conf.GetString(opt) != defaultGroupList
			} else {
				isSet = len(conf.GetString(opt)) > 0
			}
		case int:
			isSet = conf.GetInt(opt) > 0
		case bool:
			isSet = conf.GetBool(opt)
		default:
			return fmt.Errorf("unexpected option type for %s", opt)
		}
		if isSet {
			return fmt.Errorf("the option --%s should not be set", opt)
		}
	}

	return nil
}

func add(conf *viper.Viper) error {
	userId, groupId, err := getUserAndGroup(conf)
	if err != nil {
		return err
	}
	password := conf.GetString("password")
	if len(userId) != 0 {
		return userAdd(conf, userId, password)
	}

	// if we are adding a group, then the password should not have been set
	if err := checkForbiddenOpts(conf, []string{"password"}); err != nil {
		return err
	}
	return groupAdd(conf, groupId)
}

func userAdd(conf *viper.Viper, userid string, password string) error {
	dc, cancel, err := getClientWithAdminCtx(conf)
	if err != nil {
		return fmt.Errorf("unable to get admin context: %w", err)
	}
	defer cancel()

	if len(password) == 0 {
		var err error
		password, err = x.AskUserPassword(userid, "New", 2)
		if err != nil {
			return err
		}
	}

	ctx, ctxCancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer ctxCancel()
	txn := dc.NewTxn()
	defer func() {
		if err := txn.Discard(ctx); err != nil {
			glog.Errorf("Unable to discard transaction:%v", err)
		}
	}()

	user, err := queryUser(ctx, txn, userid)
	if err != nil {
		return fmt.Errorf("while querying user: %w", err)
	}
	if user != nil {
		return fmt.Errorf("unable to create user because of conflict: %v", userid)
	}

	createUserNQuads := CreateUserNQuads(userid, password)

	mu := &api.Mutation{
		CommitNow: true,
		Set:       createUserNQuads,
	}

	if _, err := txn.Mutate(ctx, mu); err != nil {
		return fmt.Errorf("unable to create user: %w", err)
	}

	fmt.Printf("Created new user with id %v\n", userid)
	return nil
}

func groupAdd(conf *viper.Viper, groupId string) error {
	dc, cancel, err := getClientWithAdminCtx(conf)
	if err != nil {
		return fmt.Errorf("unable to get admin context: %w", err)
	}
	defer cancel()

	ctx, ctxCancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer ctxCancel()
	txn := dc.NewTxn()
	defer func() {
		if err := txn.Discard(ctx); err != nil {
			fmt.Printf("Unable to discard transaction: %v\n", err)
		}
	}()

	group, err := queryGroup(ctx, txn, groupId)
	if err != nil {
		return fmt.Errorf("while querying group: %w", err)
	}
	if group != nil {
		return fmt.Errorf("group %q already exists", groupId)
	}

	createGroupNQuads := CreateGroupNQuads(groupId)

	mu := &api.Mutation{
		CommitNow: true,
		Set:       createGroupNQuads,
	}
	if _, err = txn.Mutate(ctx, mu); err != nil {
		return fmt.Errorf("unable to create group: %w", err)
	}

	fmt.Printf("Created new group with id %v\n", groupId)
	return nil
}

func del(conf *viper.Viper) error {
	userId, groupId, err := getUserAndGroup(conf)
	if err != nil {
		return err
	}
	if len(userId) != 0 {
		return userOrGroupDel(conf, userId,
			func(ctx context.Context, txn *dgo.Txn, userId string) (AclEntity, error) {
				user, err := queryUser(ctx, txn, userId)
				return user, err
			})
	}
	return userOrGroupDel(conf, groupId,
		func(ctx context.Context, txn *dgo.Txn, groupId string) (AclEntity, error) {
			group, err := queryGroup(ctx, txn, groupId)
			return group, err
		})
}

// AclEntity is an interface that must be met by all the types of entities (i.e users, groups)
// in the ACL system.
type AclEntity interface {
	// GetUid returns the UID of the entity.
	// The implementation of GetUid must check the case that the entity is nil
	// and return an empty string accordingly.
	GetUid() string
}

func userOrGroupDel(conf *viper.Viper, userOrGroupId string,
	queryFn func(context.Context, *dgo.Txn, string) (AclEntity, error)) error {
	dc, cancel, err := getClientWithAdminCtx(conf)
	if err != nil {
		return fmt.Errorf("unable to get admin context: %w", err)
	}
	defer cancel()

	ctx, ctxCancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer ctxCancel()
	txn := dc.NewTxn()
	defer func() {
		if err := txn.Discard(ctx); err != nil {
			glog.Errorf("Unable to discard transaction:%v", err)
		}
	}()

	entity, err := queryFn(ctx, txn, userOrGroupId)
	if err != nil {
		return err
	}
	if len(entity.GetUid()) == 0 {
		return fmt.Errorf("unable to delete %q since it does not exist",
			userOrGroupId)
	}

	deleteNQuads := []*api.NQuad{
		{
			Subject:     entity.GetUid(),
			Predicate:   x.Star,
			ObjectValue: &api.Value{Val: &api.Value_DefaultVal{DefaultVal: x.Star}},
		}}

	mu := &api.Mutation{
		CommitNow: true,
		Del:       deleteNQuads,
	}

	if _, err = txn.Mutate(ctx, mu); err != nil {
		return fmt.Errorf("unable to delete %q: %w", userOrGroupId, err)
	}

	fmt.Printf("Successfully deleted %q\n", userOrGroupId)
	return nil
}

func mod(conf *viper.Viper) error {
	userId, _, err := getUserAndGroup(conf)
	if err != nil {
		return err
	}

	if len(userId) != 0 {
		// when modifying the user, some group options are forbidden
		if err := checkForbiddenOpts(conf, []string{"pred", "perm"}); err != nil {
			return err
		}

		newPassword := conf.GetBool("new_password")
		groupList := conf.GetString("group_list")
		if (newPassword && groupList != defaultGroupList) ||
			(!newPassword && groupList == defaultGroupList) {
			return errors.New("one of --new_password or --group_list must be provided, but not both")
		}

		if newPassword {
			return changePassword(conf, userId)
		}

		return userMod(conf, userId, groupList)
	}

	// when modifying the group, some user options are forbidden
	if err := checkForbiddenOpts(conf, []string{"group_list", "new_password"}); err != nil {
		return err
	}
	return chMod(conf)
}

// changePassword changes a user's password
func changePassword(conf *viper.Viper, userId string) error {
	// 1. get the dgo client with appropriate access JWT
	dc, cancel, err := getClientWithAdminCtx(conf)
	if err != nil {
		return fmt.Errorf("unable to get dgo client: %w", err)
	}
	defer cancel()

	// 2. get the new password
	newPassword, err := x.AskUserPassword(userId, "New", 2)
	if err != nil {
		return err
	}

	ctx, ctxCancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer ctxCancel()
	txn := dc.NewTxn()
	defer func() {
		if err := txn.Discard(ctx); err != nil {
			glog.Errorf("Unable to discard transaction:%v", err)
		}
	}()

	// 3. query the user's current uid
	user, err := queryUser(ctx, txn, userId)
	if err != nil {
		return fmt.Errorf("while querying user: %w", err)
	}
	if user == nil {
		return fmt.Errorf("user %q does not exist", userId)
	}

	// 4. mutate the user's password
	chPdNQuads := []*api.NQuad{
		{
			Subject:     user.Uid,
			Predicate:   "dgraph.password",
			ObjectValue: &api.Value{Val: &api.Value_StrVal{StrVal: newPassword}},
		}}
	mu := &api.Mutation{
		CommitNow: true,
		Set:       chPdNQuads,
	}
	if _, err := txn.Mutate(ctx, mu); err != nil {
		return fmt.Errorf("unable to change password for user %v: %w", userId, err)
	}
	fmt.Printf("Successfully changed password for %v\n", userId)
	return nil
}

func userMod(conf *viper.Viper, userId string, groups string) error {
	dc, cancel, err := getClientWithAdminCtx(conf)
	if err != nil {
		return fmt.Errorf("unable to get admin context: %w", err)
	}
	defer cancel()

	ctx, ctxCancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer ctxCancel()
	txn := dc.NewTxn()
	defer func() {
		if err := txn.Discard(ctx); err != nil {
			fmt.Printf("Unable to discard transaction: %v\n", err)
		}
	}()

	user, err := queryUser(ctx, txn, userId)
	if err != nil {
		return fmt.Errorf("while querying user: %w", err)
	}
	if user == nil {
		return fmt.Errorf("user %q does not exist", userId)
	}

	targetGroupsMap := make(map[string]struct{})
	if len(groups) > 0 {
		for _, g := range strings.Split(groups, ",") {
			targetGroupsMap[g] = struct{}{}
		}
	}

	existingGroupsMap := make(map[string]struct{})
	for _, g := range user.Groups {
		existingGroupsMap[g.GroupID] = struct{}{}
	}
	newGroups, groupsToBeDeleted := x.Diff(targetGroupsMap, existingGroupsMap)

	mu := &api.Mutation{
		CommitNow: true,
		Set:       []*api.NQuad{},
		Del:       []*api.NQuad{},
	}

	for _, g := range newGroups {
		fmt.Printf("Adding user %v to group %v\n", userId, g)
		nquad, err := getUserModNQuad(ctx, txn, user.Uid, g)
		if err != nil {
			return err
		}
		mu.Set = append(mu.Set, nquad)
	}

	for _, g := range groupsToBeDeleted {
		fmt.Printf("Deleting user %v from group %v\n", userId, g)
		nquad, err := getUserModNQuad(ctx, txn, user.Uid, g)
		if err != nil {
			return err
		}
		mu.Del = append(mu.Del, nquad)
	}
	if len(mu.Del) == 0 && len(mu.Set) == 0 {
		fmt.Printf("Nothing needs to be changed for the groups of user: %v\n", userId)
		return nil
	}

	if _, err := txn.Mutate(ctx, mu); err != nil {
		return fmt.Errorf("while mutating the group: %w", err)
	}
	fmt.Printf("Successfully modified groups for user %v.\n", userId)
	fmt.Println("The latest info is:")
	return queryAndPrintUser(ctx, dc.NewReadOnlyTxn(), userId)
}

/*
	chMod adds/updates/deletes rule attached to group.
	1. It will return error if there is no group named <groupName>.
	2. It will add new rule if group doesn't already have a rule for the predicate.
	3. It will update the permission if group already have a rule for the predicate and permission
		is a non-negative integer between 0-7.
	4. It will delete, if group already have a rule for the predicate and the permission is
		a negative integer.
*/

func chMod(conf *viper.Viper) error {
	groupName := conf.GetString("group")
	predicate := conf.GetString("pred")
	perm := conf.GetInt("perm")
	switch {
	case len(groupName) == 0:
		return errors.New("the group must not be empty")
	case len(predicate) == 0:
		return errors.New("no predicates specified")
	case perm > 7:
		return fmt.Errorf("the perm value must be less than or equal to 7, "+
			"the provided value is %d", perm)
	}

	dc, cancel, err := getClientWithAdminCtx(conf)
	if err != nil {
		return fmt.Errorf("unable to get admin context: %w", err)
	}
	defer cancel()

	ctx, ctxCancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer ctxCancel()
	txn := dc.NewTxn()
	defer func() {
		if err := txn.Discard(ctx); err != nil {
			fmt.Printf("Unable to discard transaction: %v\n", err)
		}
	}()

	ruleQuery := fmt.Sprintf(`
	{
		var(func: eq(dgraph.xid, "%s")) @filter(type(dgraph.type.Group)) {
			gUID as uid
			rUID as dgraph.acl.rule @filter(eq(dgraph.rule.predicate, "%s"))
		}
		groupUIDCount(func: uid(gUID)) {count(uid)}
	}`, groupName, predicate)

	updateRule := &api.Mutation{
		Set: []*api.NQuad{
			{
				Subject:     "uid(rUID)",
				Predicate:   "dgraph.rule.permission",
				ObjectValue: &api.Value{Val: &api.Value_IntVal{IntVal: int64(perm)}},
			},
		},
		Cond: "@if(eq(len(rUID), 1) AND eq(len(gUID), 1))",
	}

	createRule := &api.Mutation{
		Set: []*api.NQuad{
			{
				Subject:     "_:newrule",
				Predicate:   "dgraph.rule.permission",
				ObjectValue: &api.Value{Val: &api.Value_IntVal{IntVal: int64(perm)}},
			},
			{
				Subject:     "_:newrule",
				Predicate:   "dgraph.rule.predicate",
				ObjectValue: &api.Value{Val: &api.Value_StrVal{StrVal: predicate}},
			},
			{
				Subject:   "uid(gUID)",
				Predicate: "dgraph.acl.rule",
				ObjectId:  "_:newrule",
			},
		},
		Cond: "@if(eq(len(rUID), 0) AND eq(len(gUID), 1))",
	}

	deleteRule := &api.Mutation{
		Del: []*api.NQuad{
			{
				Subject:   "uid(gUID)",
				Predicate: "dgraph.acl.rule",
				ObjectId:  "uid(rUID)",
			},
		},
		Cond: "@if(eq(len(rUID), 1) AND eq(len(gUID), 1))",
	}

	upsertRequest := &api.Request{
		Query:     ruleQuery,
		Mutations: []*api.Mutation{createRule, updateRule},
		CommitNow: true,
	}
	if perm < 0 {
		upsertRequest.Mutations = []*api.Mutation{deleteRule}
	}
	resp, err := txn.Do(ctx, upsertRequest)
	if err != nil {
		return err
	}
	var jsonResp map[string][]map[string]int
	err = json.Unmarshal(resp.GetJson(), &jsonResp)
	if err != nil {
		return err
	}

	uidCount, ok := jsonResp["groupUIDCount"][0]["count"]
	if !ok {
		return errors.New("malformed output of groupUIDCount")
	} else if uidCount == 0 {
		// We already have a check for multiple groups with same name at dgraph/acl/utils.go:142
		return fmt.Errorf("group <%s> doesn't exist", groupName)
	}
	return nil
}

func queryUser(ctx context.Context, txn *dgo.Txn, userid string) (user *User, err error) {
	query := `
    query search($userid: string){
      user(func: eq(dgraph.xid, $userid)) @filter(type(dgraph.type.User)) {
	    uid
        dgraph.xid
        dgraph.user.group {
          uid
          dgraph.xid
        }
      }
    }`

	queryVars := make(map[string]string)
	queryVars["$userid"] = userid

	queryResp, err := txn.QueryWithVars(ctx, query, queryVars)
	if err != nil {
		return nil, fmt.Errorf("while query user with id %s: %w", userid, err)
	}
	user, err = UnmarshalUser(queryResp, "user")
	if err != nil {
		return nil, err
	}
	return user, nil
}

func getUserModNQuad(ctx context.Context, txn *dgo.Txn, userId string,
	groupId string) (*api.NQuad, error) {
	group, err := queryGroup(ctx, txn, groupId)
	if err != nil {
		return nil, err
	}
	if group == nil {
		return nil, fmt.Errorf("group %q does not exist", groupId)
	}

	createUserGroupNQuads := &api.NQuad{
		Subject:   userId,
		Predicate: "dgraph.user.group",
		ObjectId:  group.Uid,
	}

	return createUserGroupNQuads, nil
}

func queryGroup(ctx context.Context, txn *dgo.Txn, groupid string,
	fields ...string) (group *Group, err error) {

	// write query header
	query := fmt.Sprintf(`
		query search($groupid: string){
			group(func: eq(dgraph.xid, $groupid)) @filter(type(dgraph.type.Group)) {
				uid
				%s
			}
		}`, strings.Join(fields, ", "))

	queryVars := map[string]string{
		"$groupid": groupid,
	}

	queryResp, err := txn.QueryWithVars(ctx, query, queryVars)
	if err != nil {
		fmt.Printf("Error while querying group with id %s: %v\n", groupid, err)
		return nil, err
	}
	group, err = UnmarshalGroup(queryResp.GetJson(), "group")
	if err != nil {
		return nil, err
	}
	return group, nil
}

func queryAndPrintUser(ctx context.Context, txn *dgo.Txn, userId string) error {
	user, err := queryUser(ctx, txn, userId)
	if err != nil {
		return err
	}
	if user == nil {
		return fmt.Errorf("the user %q does not exist", userId)
	}

	fmt.Printf("User  : %s\n", userId)
	fmt.Printf("UID   : %s\n", user.Uid)
	for _, group := range user.Groups {
		fmt.Printf("Group : %-5s\n", group.GroupID)
	}
	return nil
}

func queryAndPrintGroup(ctx context.Context, txn *dgo.Txn, groupId string) error {
	group, err := queryGroup(ctx, txn, groupId, "dgraph.xid", "~dgraph.user.group{dgraph.xid}",
		"dgraph.acl.rule{dgraph.rule.predicate, dgraph.rule.permission}")
	if err != nil {
		return err
	}
	if group == nil {
		return fmt.Errorf("the group %s doesn't exist", groupId)
	}

	fmt.Printf("Group: %s\n", groupId)
	fmt.Printf("UID  : %s\n", group.Uid)
	fmt.Printf("ID   : %s\n", group.GroupID)

	var userNames []string
	for _, user := range group.Users {
		userNames = append(userNames, user.UserID)
	}
	fmt.Printf("Users: %s\n", strings.Join(userNames, " "))

	for _, acl := range group.Rules {
		fmt.Printf("ACL: %v\n", acl)
	}

	return nil
}

func info(conf *viper.Viper) error {
	userId, groupId, err := getUserAndGroup(conf)
	if err != nil {
		return err
	}

	dc, cancel, err := getClientWithAdminCtx(conf)
	if err != nil {
		return fmt.Errorf("unable to get admin context: %w", err)
	}
	defer cancel()

	ctx, ctxCancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer ctxCancel()
	txn := dc.NewTxn()
	defer func() {
		if err := txn.Discard(ctx); err != nil {
			fmt.Printf("Unable to discard transaction: %v\n", err)
		}
	}()

	if len(userId) != 0 {
		return queryAndPrintUser(ctx, txn, userId)
	}

	return queryAndPrintGroup(ctx, txn, groupId)
}

✅ STATUS: PASS (exit code: 0)

═══════════════════════════════════════════════════════════
CATEGORY 9: FILTERING REGRESSION TESTS (10 tests)
═══════════════════════════════════════════════════════════

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 51: Filtering: Default vs explicit production-only (should match)
Command: diff <(./atse search 'Auth' /Users/danielsteigman/code/randomSource/dgraph --limit 5 --benchmark 2>&1 | grep 'Files Processed') <(./atse search 'Auth' /Users/danielsteigman/code/randomSource/dgraph --production-only --limit 5 --benchmark 2>&1 | grep 'Files Processed')

✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 52: Filtering: Test file count (with vs without)
Command: ./atse search 'Test' /Users/danielsteigman/code/randomSource/dgraph --exclude-defaults=false --limit 1 --benchmark 2>&1 | grep 'Files Processed'

Files Processed:  547
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 53: Filtering: Include test files flag
Command: ./atse search 'Mock' /Users/danielsteigman/code/randomSource/dgraph --include-tests --limit 5 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.756s
Files Processed:  346
Results Found:    0
Output Tokens:    6 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 54: Filtering: Include generated files flag
Command: ./atse search 'Proto' /Users/danielsteigman/code/randomSource/dgraph --include-generated --limit 5 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.768s
Files Processed:  346
Results Found:    5
Output Tokens:    95 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 55: Filtering: Custom exclude pattern
Command: ./atse search 'Func' /Users/danielsteigman/code/randomSource/dgraph --exclude '*/vendor/*' --limit 5 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.783s
Files Processed:  346
Results Found:    5
Output Tokens:    94 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 56: Filtering: Custom include pattern
Command: ./atse search 'Type' /Users/danielsteigman/code/randomSource/dgraph --include '**/acl/*.go' --limit 5 --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

❌ STATUS: FAIL (expected 0, got 1)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 57: Filtering: Production-only on find-fn
Command: ./atse find-fn 'Check' /Users/danielsteigman/code/randomSource/dgraph --production-only --limit 10 --benchmark 2>&1 | grep 'Files Processed'

Files Processed:  346
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 58: Filtering: Recursive vs non-recursive
Command: ./atse search 'Handler' /Users/danielsteigman/code/randomSource/dgraph/acl --recursive=false --benchmark 2>&1 | grep 'Files Processed'

Files Processed:  3
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 59: Filtering: Multiple exclude patterns
Command: ./atse search 'Data' /Users/danielsteigman/code/randomSource/dgraph --exclude '*_test.go' --exclude '*.pb.go' --limit 5 --benchmark 2>&1 | grep 'Files Processed'

Files Processed:  344
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 60: Filtering: limit 0 bypasses default limit
Command: ./atse find-fn 'Set' /Users/danielsteigman/code/randomSource/dgraph --limit 0 --benchmark 2>&1 | head -15 | grep -E '(Files|Results)'

Files Processed:  346
Results Found:    50
✅ STATUS: PASS (exit code: 0)

═══════════════════════════════════════════════════════════
CATEGORY 10: PERFORMANCE & SCALABILITY TESTS (5 tests)
═══════════════════════════════════════════════════════════

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 61: Performance: Large result set (10K+ matches)
Command: ./atse find-fn 'New' /Users/danielsteigman/code/randomSource/dgraph --limit 100 --benchmark 2>&1 | grep -E '(Warning.*[0-9]+ results|Duration|Memory|Tokens)'

Duration:         0.631s
Memory (Start):   0.3 MB
Memory (Peak):    8.7 MB
Memory (End):     8.7 MB
Output Tokens:    2490 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 62: Performance: Deep graph traversal
Command: ./atse graph 'Execute' /Users/danielsteigman/code/randomSource/dgraph --depth 4 --max-symbols 100 --benchmark 2>&1 | grep -E '(Duration|Memory|Files|Results)'

Duration:         1.683s
Memory (Start):   0.3 MB
Memory (Peak):    24.3 MB
Memory (End):     24.3 MB
Files Processed:  346
Results Found:    8
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 63: Performance: Benchmark all metrics
Command: ./atse search 'Process' /Users/danielsteigman/code/randomSource/dgraph --limit 10 --benchmark 2>&1 | grep -A 10 'Performance Benchmark'

⚡ Performance Benchmark
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Command:          search
Duration:         0.758s
Memory (Start):   0.3 MB
Memory (Peak):    6.1 MB
Memory (End):     6.1 MB
Files Processed:  346
Results Found:    10
Output Tokens:    156 (o200k_base)
Output Chars:     522
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 64: Performance: Memory efficiency
Command: ./atse graph 'Handler' /Users/danielsteigman/code/randomSource/dgraph --depth 2 --benchmark 2>&1 | grep 'Memory'

Memory (Start):   0.3 MB
Memory (Peak):    20.8 MB
Memory (End):     20.8 MB
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 65: Performance: Token counting accuracy
Command: ./atse find-fn 'Get' /Users/danielsteigman/code/randomSource/dgraph --limit 25 --benchmark 2>&1 | grep 'Output Tokens'

Output Tokens:    625 (o200k_base)
✅ STATUS: PASS (exit code: 0)

═══════════════════════════════════════════════════════════
CATEGORY 11: EDGE CASES & ERROR HANDLING (10 tests)
═══════════════════════════════════════════════════════════

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 66: Edge: Empty directory
Command: mkdir -p /tmp/empty_dir && ./atse search 'test' /tmp/empty_dir --benchmark 2>&1 && rmdir /tmp/empty_dir

No files found matching criteria.
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 67: Edge: Single file target
Command: ./atse search 'Parse' /Users/danielsteigman/code/randomSource/dgraph/acl/acl.go --benchmark 2>&1 | grep -E '(Duration|Files|Results|Tokens)'

Duration:         0.003s
Files Processed:  1
Results Found:    0
Output Tokens:    6 (o200k_base)
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 68: Edge: Very long symbol name
Command: ./atse search 'VeryLongSymbolNameThatProbablyDoesNotExistInTheCodebase123' /Users/danielsteigman/code/randomSource/dgraph --benchmark 2>&1 | grep 'Results Found'

Results Found:    0
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 69: Edge: Special characters in search
Command: ./atse search 'Test_' /Users/danielsteigman/code/randomSource/dgraph --limit 5 --benchmark 2>&1 | grep -E '(Duration|Results)'

Duration:         0.756s
Results Found:    0
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 70: Edge: Case sensitivity
Command: ./atse search 'query' /Users/danielsteigman/code/randomSource/dgraph --limit 5 --benchmark 2>&1 | grep 'Results Found'

Results Found:    5
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 71: Edge: Zero limit (should use default)
Command: ./atse find-fn 'Run' /Users/danielsteigman/code/randomSource/dgraph --limit 0 --benchmark 2>&1 | head -10 | grep 'Results Found'

Results Found:    50
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 72: Edge: Negative depth (should error)
Command: ./atse graph 'Test' /Users/danielsteigman/code/randomSource/dgraph --depth -1 2>&1

Symbol 'Test' not found in codebase.
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 73: Edge: Non-existent path
Command: ./atse search 'test' /nonexistent/path 2>&1

Error: failed to collect files: stat /nonexistent/path: no such file or directory
Usage:
  atse search <query> [path] [flags]

Flags:
      --fuzzy         Enable fuzzy matching
  -h, --help          help for search
      --type string   Filter by symbol type (function, class, method, variable)

Global Flags:
      --benchmark                 Display performance benchmark summary to stderr
      --exclude strings           Exclude file patterns (e.g., '*.test.ts')
      --exclude-defaults          Apply default exclude patterns for common noise (tests, generated, node_modules) (default true)
      --format string             Output format: text, json, locations (default "text")
      --include strings           Include file patterns (e.g., '*.ts')
      --include-generated         Include generated files in results
      --include-tests             Include test files in results
      --limit int                 Limit number of results (0 = no limit)
      --log-metrics               Log command output token metrics to a JSONL file
      --metrics-log-file string   Path to append metrics logs (JSONL) (default "benchmark/results/raw/token_metrics.jsonl")
      --no-cache                  Bypass parse tree cache
      --production-only           Only show production code (exclude tests, generated files)
      --rebuild-index             Force rebuild of symbol index (ignore cache)
  -r, --recursive                 Recursively search directories (default true)
      --token-model string        Model name used for token counting (for reference only) (default "gpt-4o")
  -v, --verbose                   Verbose output with additional context

failed to collect files: stat /nonexistent/path: no such file or directory
❌ STATUS: FAIL (expected 0, got 1)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 74: Edge: Path is a file not directory (for list-fns)
Command: ./atse list-fns /Users/danielsteigman/code/randomSource/dgraph/acl/acl.go --benchmark 2>&1 | grep -E '(Duration|Files|Results)'

Duration:         0.004s
Files Processed:  1
Results Found:    17
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 75: Edge: Very small limit (1 result)
Command: ./atse search 'Handle' /Users/danielsteigman/code/randomSource/dgraph --limit 1 --benchmark 2>&1 | grep 'Results Found'

Results Found:    1
✅ STATUS: PASS (exit code: 0)

═══════════════════════════════════════════════════════════
CATEGORY 12: FORMAT OPTIONS TESTS (5 tests)
═══════════════════════════════════════════════════════════

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 76: Format: text output (default)
Command: ./atse search 'Query' /Users/danielsteigman/code/randomSource/dgraph --limit 3 --format text --benchmark 2>&1 | grep -E '(Found.*symbol|Duration)'

Duration:         0.743s
Found 3 symbol(s):
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 77: Format: JSON output
Command: ./atse search 'Server' /Users/danielsteigman/code/randomSource/dgraph --limit 3 --format json --benchmark 2>&1 | grep -E '(\[|Duration)'

Duration:         0.739s
[
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 78: Format: locations output
Command: ./atse search 'Login' /Users/danielsteigman/code/randomSource/dgraph --limit 3 --format locations --benchmark 2>&1 | grep -E '(:[0-9]+:|Duration)'

Duration:         0.740s
/Users/danielsteigman/code/randomSource/dgraph/testutil/multi_tenancy.go:48:5
/Users/danielsteigman/code/randomSource/dgraph/edgraph/access.go:42:17
/Users/danielsteigman/code/randomSource/dgraph/testutil/docker.go:124:28
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 79: Format: JSON with find-fn
Command: ./atse find-fn 'Parse' /Users/danielsteigman/code/randomSource/dgraph --format json --limit 5 --benchmark 2>&1 | grep 'Duration'

Duration:         0.616s
✅ STATUS: PASS (exit code: 0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST 80: Format: locations with deps
Command: ./atse deps /Users/danielsteigman/code/randomSource/dgraph/acl/acl.go --format locations --benchmark 2>&1 | grep 'Duration'

Duration:         0.003s
✅ STATUS: PASS (exit code: 0)

═══════════════════════════════════════════════════════════
COMPREHENSIVE TEST SUITE SUMMARY
═══════════════════════════════════════════════════════════

Total Tests:  80
Passed:       69
Failed:       11
Pass Rate:     Pass Rate:    

❌ SOME TESTS FAILED - REVIEW RESULTS ABOVE
═══════════════════════════════════════════════════════════
Test Suite Completed: Tue Nov 18 22:15:44 PST 2025
═══════════════════════════════════════════════════════════
